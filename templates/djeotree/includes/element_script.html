{% load geojson_tags %}

<script type="text/javascript">
  function map_init(map, options) {

    function onEachFeature(feature, layer) {
      if (feature.properties && feature.properties.popupContent) {
        layer.bindPopup(feature.properties.popupContent.content, {minWidth: 256});
      }
    }

    function setLineStyle(feature) {
      return {"color": feature.properties.popupContent.color, "weight": 5 };
    }

    const base_map = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        attribution: '',
        maxZoom: 19,
      }).addTo(map);

    const sat_map = L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",
      {
        attribution: 'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 19,
        tileSize: 512,
        zoomOffset: -1,
        id: "mapbox/satellite-v9",
        accessToken: "{{ mapbox_token }}"
      });

    const baseMaps = {
      "Base": base_map,
      "Satellite": sat_map
    };

    L.control.layers(baseMaps).addTo(map);

    let mk_layer = L.layerGroup().addTo(map);
    let ln_layer = L.layerGroup().addTo(map);

    let collection = {{ elements|geojsonfeature:"popupContent"|safe }};
    let markers = L.geoJson(collection, {onEachFeature: onEachFeature});
    markers.addTo(mk_layer);
    map.fitBounds(markers.getBounds(), {padding: [30,30]});
    collection = {{ lines|geojsonfeature:"popupContent"|safe }};
    let lines = L.geoJson(collection, {style: setLineStyle, onEachFeature: onEachFeature});
    lines.addTo(ln_layer);

    addEventListener("refreshData", function(evt){
      mk_layer.clearLayers();
      ln_layer.clearLayers();
      let collection = evt.detail;
      let markers = L.geoJson(collection, {onEachFeature: onEachFeature});
      markers.addTo(mk_layer);
      map.fitBounds(markers.getBounds(), {padding: [30,30]});
    })
  }
</script>
